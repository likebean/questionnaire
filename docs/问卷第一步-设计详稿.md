# 问卷第一步 - 设计详稿

> 在《问卷第一步-设计讨论.md》定稿基础上展开，含数据模型、API、页面规格、组件结构与关键流程。范围与定稿以《问卷第一步-范围说明.md》《问卷第一步-设计讨论.md》为准。

---

## 一、数据模型

### 1.1 实体关系概览

```
Survey（问卷） 1 ── N SurveyQuestion（题目）
SurveyQuestion  1 ── N QuestionOption（选项，仅单选/多选/量表有）
Survey          1 ── 1 SurveySettings（问卷设置，可合并到 Survey 或独立表）
Survey          1 ── N Response（答卷）
Response        1 ── N ResponseItem（答卷项，每题一条）
```

### 1.2 问卷（Survey）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ | 雪花或自增 |
| title | string | ✓ | 问卷标题，单行 |
| description | string |  | 问卷说明/前言，纯文本 |
| status | enum | ✓ | DRAFT / COLLECTING / PAUSED / ENDED |
| creator_id | FK 用户 | ✓ | 创建者，仅创建者可编辑/查看数据 |
| created_at | datetime | ✓ |  |
| updated_at | datetime | ✓ |  |
| deleted_at | datetime |  | 软删除（若采用） |

**状态流转**：DRAFT →（发布）→ COLLECTING →（暂停回收）→ PAUSED →（重新开启）→ COLLECTING；COLLECTING/PAUSED →（结束问卷）→ ENDED。

### 1.3 题目（SurveyQuestion）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ |  |
| survey_id | FK Survey | ✓ |  |
| sort_order | int | ✓ | 题目顺序，从 0 或 1 起 |
| type | enum | ✓ | SINGLE_CHOICE / MULTIPLE_CHOICE / SHORT_TEXT / LONG_TEXT / SCALE |
| title | string | ✓ | 题目标题（题干） |
| description | string |  | 题目说明/备注 |
| required | boolean | ✓ | 是否必填 |
| **单选题** |  |  |  |
| (选项在 QuestionOption) |  |  |  |
| **多选题** |  |  |  |
| min_choices | int |  | 最少选几项，可选 |
| max_choices | int |  | 最多选几项，可选 |
| **填空题** |  |  |  |
| placeholder | string |  | 占位提示 |
| multiline | boolean |  | true=多行，false=单行 |
| **量表题** |  |  |  |
| scale_min | int |  | 一般为 1 |
| scale_max | int |  | 如 5/7/10 |
| scale_left_label | string |  | 左端点文案 |
| scale_right_label | string |  | 右端点文案 |
| created_at / updated_at |  | ✓ |  |

**说明**：多选题的 min_choices/max_choices、填空的 placeholder/multiline、量表的 scale_* 可放 question 表，也可用 JSON 字段 `extra_config` 存，依实现偏好。

### 1.4 选项（QuestionOption）

仅题型为 SINGLE_CHOICE、MULTIPLE_CHOICE、SCALE 时使用；SCALE 可为每刻度一条 option（如 1～5）或仅用 scale_min/scale_max 渲染。

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ |  |
| question_id | FK SurveyQuestion | ✓ |  |
| sort_order | int | ✓ | 选项顺序 |
| label | string | ✓ | 选项文案 |
| allow_fill | boolean |  | 「其他」是否允许填空；仅单选/多选时用 |
| is_other | boolean |  | 是否「其他」选项 |

### 1.5 问卷设置（SurveySettings 或 Survey 扩展字段）

可与 Survey 合并为一张表，以下为逻辑字段。

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| survey_id |  | ✓ | 若独立表则 FK Survey |
| limit_once_per_user | boolean | ✓ | 每人限填一次（按登录 user_id） |
| allow_anonymous | boolean | ✓ | 允许匿名；匿名时不记 user_id |
| start_time | datetime |  | 选填；未到不开放填写 |
| end_time | datetime |  | 选填；过后禁止提交 |
| thank_you_text | string |  | 提交成功后展示的感谢语 |

**组合逻辑**：allow_anonymous=true 时未登录可填，不关联 user_id；limit_once_per_user=true 且 allow_anonymous=false 时必须登录且按 user_id 防重复。

### 1.6 答卷（Response）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ |  |
| survey_id | FK Survey | ✓ |  |
| user_id | FK 用户 |  | 匿名时为 null |
| submitted_at | datetime | ✓ | 提交时间 |
| duration_seconds | int |  | 用时（秒），可选 |
| created_at / updated_at |  | ✓ |  |

### 1.7 答卷项（ResponseItem）

每题一条，存该题答案。

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ |  |
| response_id | FK Response | ✓ |  |
| question_id | FK SurveyQuestion | ✓ |  |
| value_type | enum | ✓ | OPTION / TEXT / SCALE 等，与题型对应 |
| option_ids | string/JSON |  | 多选为 id 数组；单选为单 id |
| text_value | string |  | 填空、「其他」填空 |
| scale_value | int |  | 量表题分值 |

**说明**：可简化为 option_id（单选/量表）、option_ids（多选）、text_value（填空/其他），依实现选一种或混合。

### 1.8 待我填写的列表（第一步不做）

与问卷星一致：不做「待我填写的」列表；填写统一通过问卷链接打开。

---

## 二、REST API 设计

### 2.1 统一约定

- **Base**：`/api`（前端 rewrites 到后端）。
- **响应体**：`{ code: number, message?: string, data?: T }`，成功 code=200 或 0（与现有项目一致即可）。
- **列表分页**：`page`（从 1）、`pageSize`，响应含 `total` 或 `list + total`。
- **鉴权**：需登录的接口带 Cookie/Authorization；创建者校验在服务端做。

### 2.2 问卷

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/surveys | 我的问卷列表（我创建的） | Query: status?, keyword?, page, pageSize, sort=updatedAt\|createdAt。Response: { list: SurveyListItem[], total } |
| POST | /api/surveys | 创建问卷（草稿） | Body: { title, description? }。Response: Survey（含 id），前端跳转 /surveys/[id]/edit |
| GET | /api/surveys/:id | 问卷详情（含题目、选项、设置） | 用于编辑页/设置页拉取全量；仅创建者可访问 |
| PUT | /api/surveys/:id | 更新问卷基础信息（标题、说明） | Body: { title, description? } |
| POST | /api/surveys/:id/publish | 发布（草稿→收集中） | 校验至少一题、必填完整等 |
| POST | /api/surveys/:id/pause | 暂停回收 |
| POST | /api/surveys/:id/resume | 重新开启 |
| POST | /api/surveys/:id/end | 结束问卷 |
| POST | /api/surveys/:id/copy | 复制问卷 | Response: 新 Survey（草稿），含题目与设置，不含答卷 |
| DELETE | /api/surveys/:id | 删除问卷（软删或物理删） | 仅创建者 |

**SurveyListItem**：id, title, status, responseCount?, updatedAt, createdAt。

### 2.3 题目

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/surveys/:surveyId/questions | 题目列表（含选项） | 按 sort_order 返回，编辑页左侧+右侧用 |
| POST | /api/surveys/:surveyId/questions | 新增题目 | Body: 见下 QuestionCreate。Response: SurveyQuestion（含 id） |
| PUT | /api/surveys/:surveyId/questions/:questionId | 更新题目 | Body: 题干、题型、必填、选项/刻度等 |
| PUT | /api/surveys/:surveyId/questions/order | 题目排序 | Body: { questionIds: string[] } 或 { fromIndex, toIndex } |
| POST | /api/surveys/:surveyId/questions/:questionId/copy | 复制题目 | Response: 新题目，插入原题后 |
| DELETE | /api/surveys/:surveyId/questions/:questionId | 删除题目 | 收集中/已暂停时保存需强提示，见 2.2 业务规则 |

**QuestionCreate/Update**（示例）：  
type, title, description?, required, sort_order?；  
单选/多选：options: [{ label, isOther?, allowFill? }]，多选加 min_choices?, max_choices?；  
填空：placeholder?, multiline?；  
量表：scale_min, scale_max, scale_left_label?, scale_right_label?。

### 2.4 问卷设置

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/surveys/:id/settings | 获取设置 | Response: SurveySettings |
| PUT | /api/surveys/:id/settings | 保存设置 | Body: limit_once_per_user, allow_anonymous, start_time?, end_time?, thank_you_text? |

### 2.5 发放（链接）

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/surveys/:id/fill-url | 获取填写链接 | Response: { url: string }，如 `https://host/fill/xxx` 或短码 |

无需单独「发放」接口，发布后即生成固定链接；前端在设置页或单独「发放」区块展示该 URL + 复制按钮。

### 2.6 填写端（C 端）

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/fill/:id 或 /api/s/:shortCode | 问卷填写元数据（用于渲染填写页） | 匿名/登录皆可访问（若问卷允许匿名）。Response: Survey 基础信息 + 题目列表（含选项/刻度），不包含答卷。若问卷已删除/未到开始/已结束/已填过（防重复）返回 4xx + 明确 code/message |
| POST | /api/fill/:id/submit 或 /api/s/:shortCode/submit | 提交答卷 | Body: { items: [{ questionId, optionIds?|optionId?, textValue?, scaleValue? }], durationSeconds? }。需登录时带鉴权；匿名时无 user_id。Response: 成功 200，前端展示感谢语 |

**填写前校验**（GET 填写页时后端可返回）：  
- 问卷不存在/已删除 → 404 或 400，message「问卷已删除」  
- 未到开始时间 → 400，message「未到开始时间」  
- 已过结束时间 → 400，message「问卷已截止」  
- 防重复且已填过 → 400，message「您已填写过本问卷」

### 2.7 答卷与统计

| 方法 | 路径 | 说明 | 请求体 / 响应 |
|------|------|------|----------------|
| GET | /api/surveys/:id/responses | 答卷列表 | Query: page, pageSize。Response: { list: ResponseListItem[], total }。ListItem: id, submittedAt, durationSeconds?, summary?: string（如前两题答案摘要） |
| GET | /api/surveys/:id/responses/:responseId | 单条答卷详情 | 逐题答案，用于「查看详情」页 |
| GET | /api/surveys/:id/analytics | 单题统计 | Response: { questions: [{ questionId, type, summary }] }。summary 依题型：单选/多选为 options: [{ optionId, label, count, ratio }]；量表为 avg, distribution: [{ value, count }]；填空为 list: string[]（可分页） |
| GET | /api/surveys/:id/export | 导出 Excel | 返回文件流或下载 URL；第一步为「全部答卷」 |

---

## 三、页面规格详稿

### 3.1 我的问卷列表 `/surveys`

**说明**：与问卷星一致，仅「我创建的」问卷列表，不做「待我填写的」Tab；填写通过链接打开。

**布局**：沿用现有 AppLayout（侧栏 + 主区）。主区：标题「我的问卷」；表格 + 行操作。

- **筛选与搜索**：状态下拉或 Tab：全部 / 草稿 / 收集中 / 已暂停 / 已结束；关键词搜索（问卷标题）；排序：最近更新 / 最近创建（默认最近更新）。
- **表格列**：问卷标题（可点击进编辑）、状态（徽章）、回收数（收集中/已暂停/已结束时显示）、更新时间、操作。
- **行操作**：设计问卷（→ edit）、设置（→ settings）、发放（→ 同设置或弹窗展示链接+复制）、查看答卷（→ responses）、统计分析（→ analytics）、复制、删除（二次确认）。草稿无「发放/答卷/统计」或置灰并提示先发布。
- **顶部按钮**：「创建问卷」→ POST /api/surveys 后跳转 /surveys/[id]/edit。

**空状态**：暂无问卷时，引导「创建问卷」；填写通过分享链接参与。

### 3.2 问卷编辑页 `/surveys/[id]/edit`

**权限**：仅创建者可编辑；非创建者 403 或重定向列表。

**布局**

- **顶部区**：问卷标题（单行输入，必填）、问卷说明（多行选填）；右侧/底部：**保存草稿**（草稿时）、**发布**（草稿时）、**保存**（收集中/已暂停时，带强确认）。发布前校验：至少一题、每题题干非空、必填选项完整（单选/多选至少有选项）。
- **左侧**：题目列表。每项：题号 + 题干缩写（过长截断，如 20 字）；选中态高亮；支持拖拽排序或上移/下移；底部按钮「添加题目」。新增题目默认插入当前选中题下方，无选中则插到末尾。
- **右侧**：当前题目编辑。
  - 题目标题（必填）、题目说明（选填）、题型下拉（单选/多选/填空-单行/填空-多行/量表）、必填勾选。
  - **单选题**：选项列表，每项可编辑文案、删除、上移下移；勾选「其他」且「允许填空」；底部「添加选项」。
  - **多选题**：同上 + 最少选 N、最多选 N（数字输入）。
  - **填空题**：单行/多行切换、占位提示输入。
  - **量表题**：刻度数（如 5/7/10 选择或输入）、左端点文案、右端点文案。
  - 题目操作：上移、下移、复制题目、删除题目（确认）。

**状态与提示**

- 草稿：保存草稿、发布；无「保存」。
- 收集中/已暂停：显示「保存」；点击保存时弹窗「修改题目会影响已回收数据与统计，是否继续？」确认后再 PUT 题目接口。

**添加题目**：点击后可在当前选中下插入新题（默认题型可为单选），或先插入再在右侧选题型。

### 3.3 问卷设置页 `/surveys/[id]/settings`

**区块**

- **防重复**：开关「每人限填一次」；说明：开启后仅登录用户可填且每个用户只能提交一次（与匿名互斥说明）。
- **匿名**：开关「允许匿名填写」；说明：匿名时不记录填写人，与防重复组合时逻辑见 1.5。
- **时间**：开始时间、结束时间（日期时间选择器，选填）；说明：不填表示不限制。
- **感谢语**：多行文本，提交成功后展示。

底部「保存」→ PUT /api/surveys/:id/settings。可选在同一页或单独区块展示**填写链接**（GET fill-url）+ 复制按钮，便于发放。

### 3.4 发放（链接展示）

可在设置页内一区块，或列表行操作「发放」打开弹窗。内容：问卷填写链接（只读文本框或直接展示 URL）、按钮「复制链接」。复制成功后 Toast「已复制到剪贴板」。

### 3.5 答卷列表 `/surveys/[id]/responses`

**布局**：面包屑 我的问卷 > [标题] > 查看答卷；表格：提交时间、用时（可选）、摘要（如前两题答案，截断）；分页。点击行或「查看」→ 单条答卷详情（弹窗或新页）。

**单条详情**：按题目顺序展示每题题干 + 该答卷的答案（选项文案或填空内容或量表分值）。

**空状态**：暂无答卷时提示「发布问卷并分享链接后，答卷将显示在这里」。

### 3.6 单题统计与导出 `/surveys/[id]/analytics`

**布局**：面包屑 我的问卷 > [标题] > 统计分析。按题目顺序逐题展示：

- **单选/多选**：表格（选项、人数、占比）+ 饼图或柱状图（至少一种）。
- **量表**：平均分、分布（柱状或表格：分值-人数）。
- **填空**：答案列表（可分页或懒加载），第一步不做词云。

顶部或底部按钮「导出 Excel」→ GET /api/surveys/:id/export，触发下载。

### 3.7 填写页 `/fill/[id]` 或 `/s/[shortCode]`

**前置校验**（进入页时请求 GET 填写元数据）：  
若返回 4xx：问卷已删除 / 未到开始时间 / 已截止 / 已填过（防重复）→ 页面展示统一错误区，文案明确，不展示题目。

**正常渲染**

- 顶部：问卷标题、问卷说明。
- 题目区：按题序一页展示；每题题号、题干、必填星号、输入控件（单选 radio、多选 checkbox、单行/多行 input/textarea、量表 1～N 单选或滑块）。
- 底部：提交按钮。提交前前端校验必填；不通过时 Toast 或内联提示，并滚动到首道未填题。
- 提交成功：隐藏题目区，展示感谢语（设置中的 thank_you_text）；可提供「关闭」或返回首页链接。

**匿名与登录**：若问卷要求仅登录可填，未登录时先跳转登录，登录后回填；匿名问卷不要求登录。

**响应式**：填写页做移动端适配（布局、字号、点击区域），便于手机打开链接填写。

---

## 四、前端组件结构与关键流程

### 4.1 路由与页面组件（建议）

```
app/
  surveys/
    page.tsx                 # 我的问卷列表（我创建的 + 状态筛选，同问卷星）
    new/
      page.tsx               # 创建问卷（POST 后 redirect 到 edit）
    [id]/
      edit/
        page.tsx             # 编辑页（左侧题目列表 + 右侧编辑）
      settings/
        page.tsx             # 问卷设置
      responses/
        page.tsx             # 答卷列表
        [responseId]/
          page.tsx           # 单条答卷详情（可选）
      analytics/
        page.tsx             # 单题统计 + 导出
  fill/
    [id]/
      page.tsx               # 填写页（或 s/[shortCode] 同源）
```

### 4.2 可复用组件建议

- **SurveyQuestionEditor**：单题编辑区，根据 type 渲染题干、题型、选项/填空/量表配置。
- **QuestionOptionList**：选项列表（增删改、排序、其他+填空）。
- **SurveyQuestionList**：左侧题目列表（题号+题干缩写、选中、拖拽/上下移、添加题目）。
- **FillQuestion**：填写页单题渲染（题干 + 控件）；由 FillPage 循环题目渲染。
- **ScaleDisplay**：量表题在填写页的 1～N 单选或滑块。
- **AnalyticsChart**：单题统计图表（饼图/柱状图），可用 Recharts 或类似库。
- **ConfirmDialog**：保存时「影响已回收数据」等二次确认。

状态管理：编辑页问卷与题目列表用 React Query（useQuery/useMutation）；表单用受控组件或 React Hook Form + Zod 校验。

### 4.3 关键用户流程（简要）

1. **创建并发布**：我的问卷 → 创建问卷 → 编辑标题/说明、添加题目、保存草稿 → 设置（防重复/匿名/时间/感谢语）→ 发布 → 复制链接分享。
2. **填写**：打开问卷链接 → 若需登录则先登录 → 填写题目 → 提交 → 感谢语。
3. **查看数据**：我的问卷 → 某条 → 查看答卷（列表+详情）/ 统计分析（单题统计+导出 Excel）。
4. **收集中修改题目**：编辑页修改后点「保存」→ 强提示「会影响已回收数据与统计，是否继续？」→ 确认后保存。
5. **暂停/开启/结束**：列表行操作或详情区操作「暂停回收」「重新开启」「结束问卷」。

---

## 五、交付与实现顺序建议

1. **后端**：Survey/SurveyQuestion/QuestionOption/SurveySettings/Response/ResponseItem 表与 CRUD；问卷状态机；防重复与匿名逻辑；填写提交与校验；统计聚合与导出 Excel。
2. **前端**：我的问卷列表（Tab、筛选、表格、创建）；编辑页（左列表+右编辑、题目 CRUD、排序、保存/发布）；设置页；填写页（元数据拉取、校验、提交、感谢页）；答卷列表与详情；单题统计与导出。
3. **联调**：发布→复制链接→填写→提交→查看答卷与统计→导出。

本文档与《问卷第一步-设计讨论.md》《问卷第一步-范围说明.md》一起，作为第一步开发与评审的详细依据。
