# 问卷第二步 - 设计详稿

> 在《问卷第二步-范围说明.md》基础上展开，含数据模型、逻辑与题型配置、API、页面规格、组件与关键流程。第一步能力沿用《问卷第一步-设计详稿.md》；本稿仅描述第二步**新增与变更**部分。

---

## 一、数据模型（第二步新增与扩展）

### 1.1 实体关系概览（沿用 + 扩展）

```
Survey（问卷） 1 ── N SurveyQuestion（题目）   # 题目增加 logic 与题型扩展
Survey          1 ── N Response（答卷）       # Response 增加 status(DRAFT/SUBMITTED)、is_valid
Response        1 ── N ResponseItem（答卷项） # 支持新题型取值
                1 ── N ResponseEditLog（答卷修改记录，第二步新增）
```

### 1.2 问卷（Survey）扩展字段

第一步已有字段不变。第二步在 Survey 表**新增**以下字段（或合并进现有 JSON 设置字段，依实现约定）：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| pagination_mode | enum | ✓ | NONE / BY_PAGE_BREAK / BY_N；默认 NONE |
| page_size | int |  | 当 pagination_mode=BY_N 时，每页题数 |
| allow_prev_page | boolean | ✓ | 分页时是否允许「上一页」；默认 true |
| time_limit_minutes | int |  | 单次填写限时（分钟），null 表示不限时 |
| max_responses | int |  | 最大回收数，null 表示不限制 |
| show_question_nav | boolean | ✓ | 填写页是否显示题目导航（题号列表 + 已填/未填 + 点击跳转）；默认 true |

### 1.3 题目（SurveyQuestion）扩展

**题型枚举扩展**（type 新增）：

- SINGLE_CHOICE / MULTIPLE_CHOICE / SHORT_TEXT / LONG_TEXT / SCALE（第一步已有）
- **DROPDOWN_SINGLE**（下拉单选）、**DROPDOWN_MULTIPLE**（下拉多选）——**说明**：问卷星仅有「多级下拉框题」，不存在普通单级下拉题；本两项为单级下拉，属**本系统扩展**（可选）。若与问卷星严格对齐，第二步可不做单级下拉，仅第三步做多级下拉。
- **MATRIX_SINGLE**（矩阵单选，必做）、**MATRIX_MULTIPLE**（矩阵多选）、**MATRIX_INPUT**（矩阵填空，可选）
- **RANK**（排序题）
- **DATE**（日期题）、**TIME**（时间题）
- **PARAGRAPH**（段落说明，不收集答案）
- **PAGE_BREAK**（分页符，不收集答案）

**逻辑配置**：在题目上增加 **logic** 字段（JSON，可选），或合并进 **config**。建议独立 **logic** 便于解析与校验。

| 逻辑类型 | 存储位置 | 结构说明 |
|----------|----------|----------|
| 跳题 | question.logic.jump | 见下 1.4 |
| 题目显隐 | 被控题 question.logic.visibility | 见下 1.4 |
| 选项显隐 | 被控题 question.logic.optionVisibility | 见下 1.4 |
| 选项引用 | question.logic.optionSource | 见下 1.4 |
| 条件必填 | question.logic.requiredCondition | 见下 1.4 |

**config 扩展**（按题型）：**各题型配置均参考问卷星题型专属设置**（问卷星帮助中心「设计问卷」→「题型说明」），与第一步题型一致处（如选项随机、竖向/横向、标签化）沿用第一步 config 约定。

**下拉单选 / 下拉多选**（若做单级下拉）

| 字段 | 类型 | 说明（参考问卷星） |
|------|------|---------------------|
| options | array | 同单选题；hasOtherOption、otherAllowFill |
| minChoices / maxChoices | int | 下拉多选：最少/最多选几项 |
| optionsRandom | boolean | 选项随机展示 |
| layout | enum | 竖向/横向（下拉框时可为 single 下拉） |

**矩阵单选 / 矩阵多选 / 矩阵填空**

| 字段 | 类型 | 说明（参考问卷星） |
|------|------|---------------------|
| rows | array | 行标签数组 |
| columns | array | 列标签数组 |
| rowsRandom | boolean | 行随机展示 ★问卷星 |
| columnsRandom | boolean | 列随机展示 ★问卷星 |
| perRowRequired | boolean | 每行是否必选（矩阵单选/多选）★问卷星 |
| requiredRows | array | 或指定哪些行必选，如 [0,1] |

**排序题**

| 字段 | 类型 | 说明（参考问卷星） |
|------|------|---------------------|
| options | array | 同单选，选项列表 |
| optionsRandom | boolean | 选项随机展示 ★问卷星 |

填写值为顺序数组如 [2,0,1] 表示原选项 0、1、2 的排名。

**日期题**

| 字段 | 类型 | 说明（参考问卷星） |
|------|------|---------------------|
| dateMin | string | 可选，ISO 日期 "YYYY-MM-DD"，最小日期 ★问卷星 |
| dateMax | string | 可选，最大日期 ★问卷星 |

**时间题**

| 字段 | 类型 | 说明（参考问卷星） |
|------|------|---------------------|
| timeFormat | string | 可选，如 "HH:mm" / "HH:mm:ss" 等 |

**段落说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| content | string | 段落正文（富文本或纯文本，依实现） |

**分页符**：无 config 或仅占位。

### 1.4 逻辑配置结构（logic JSON）

以下为 **logic** 字段建议结构；条件来自「当前题之前」的题目。**设置顺序**（对标问卷星）：**跳题从前往后**设置，**题目关联（显隐）从后往前**设置（后面题关联前面题和选项）；支持对多题**批量设置**相同关联条件。

**跳题（jump）**——仅单选、下拉单选（多选建议用题目显隐，不用跳题）：

```json
{
  "jump": {
    "rules": [
      { "when": { "optionIndex": 0 }, "action": "goto", "targetQuestionId": "uuid-of-q" },
      { "when": { "optionIndex": 1 }, "action": "end" }
    ]
  }
}
```

when 可扩展为多条件组合（见下）。targetQuestionId 为题号或题目 ID（建议 ID 稳定）。

**题目显隐（visibility）**——某题是否显示：

```json
{
  "visibility": {
    "defaultVisible": false,
    "conditions": {
      "logic": "or",
      "items": [
        { "questionId": "q1", "op": "selected", "optionIndex": 0 },
        { "questionId": "q2", "op": "selected", "optionIndices": [0, 1] }
      ]
    }
  }
}
```

op：selected（单选/下拉选某选项）、notSelected、selectedAny（多选包含某选项）等。

**选项显隐（optionVisibility）**——同一题内部分选项显示与否：

```json
{
  "optionVisibility": [
    { "optionIndex": 2, "conditions": { "logic": "and", "items": [{ "questionId": "q1", "op": "selected", "optionIndex": 0 }] } },
    { "optionIndex": 3, "conditions": { ... } }
  ]
}
```

**选项引用（optionSource）**——本题选项来源于前题已选：

```json
{
  "optionSource": { "sourceQuestionId": "uuid-of-multi-question" }
}
```

本题为单选/多选/下拉时，选项列表 = 前题（多选/多选下拉）的被选选项；未选时可为空或提示「请先作答上一题」。

**条件必填（requiredCondition）**：

```json
{
  "requiredCondition": {
    "logic": "and",
    "items": [{ "questionId": "q1", "op": "selected", "optionIndex": 2 }]
  }
}
```

当条件满足时本题为必填；否则选填。提交校验时按当前答案计算条件，再决定是否校验本题必填。

**多条件组合**：items 内可嵌套 logic+items（与/或/非），条件数 2～N；实现时约定最大层级或扁平化存储。

### 1.5 答卷（Response）扩展

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | enum | ✓ | DRAFT（草稿，每题自动保存）/ SUBMITTED（已提交）；第一步已有数据默认为 SUBMITTED |
| submitted_at | datetime |  | 仅当 status=SUBMITTED 时必填；DRAFT 时为空 |
| is_valid | boolean | ✓ | 是否有效；默认 true；标记无效后为 false，不计入统计与导出（按筛选）；仅对 SUBMITTED 答卷生效 |

**草稿（DRAFT）与自动保存**：同一用户（user_id）在同一问卷下最多存在**一条** status=DRAFT 的答卷，用于「每题/每步自动保存」；进入填写页时若存在则拉取并回填，作答过程中前端按题或按步（如翻页、失焦）调用保存接口更新该草稿的 ResponseItem；用户点击「提交」时校验必填后将该答卷 status 置为 SUBMITTED 并写入 submitted_at。匿名问卷是否支持草稿可约定（如按会话/cookie 关联草稿，或仅登录用户支持草稿）。

### 1.6 答卷修改记录（ResponseEditLog，第二步新增）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | 主键 | ✓ |  |
| response_id | FK Response | ✓ |  |
| question_id | FK SurveyQuestion | ✓ | 被修改的题目 |
| operator_id | FK 用户 | ✓ | 谁修改 |
| edited_at | datetime | ✓ | 何时修改 |
| old_value | JSON/text |  | 原答案（选项下标、文本、量表值等） |
| new_value | JSON/text |  | 新答案 |

用于「编辑答卷」后审计与「修改记录」展示。

### 1.7 答卷项（ResponseItem）与题型对应

第一步已有 value_type、optionIndex/optionIndices、text_value、scale_value。第二步扩展：

- **排序题**：value_type=RANK，存顺序数组 JSON，如 "[2,0,1]" 表示选项 0、1、2 的排名顺序。
- **日期题**：value_type=DATE，text_value 存 ISO 日期字符串 "YYYY-MM-DD"。
- **时间题**：value_type=TIME，text_value 存时间字符串。
- **矩阵单选**：value_type=MATRIX_SINGLE，存行索引与列索引，如 rowIndex+columnIndex 或 JSON { rowIndex, columnIndex }。
- **矩阵多选**：value_type=MATRIX_MULTIPLE，存多格选择 JSON。
- **矩阵填空**：value_type=MATRIX_INPUT，存多格文本 JSON（如 { "0_1": "xx", "1_2": "yy" }）。
- **段落/分页符**：不产生 ResponseItem。

被跳题或显隐隐藏的题目：该题无 ResponseItem，或有一条占位项标注「未作答（已跳过）」（统计/导出时按「未作答」处理）。

**实现注意**：统计与导出按**当前题目结构**计算；历史答卷中已删除的题目留空或标「题目已删除」；被跳过/未展示的题目在统计中计为未作答（可选展示「未作答（已跳过）」）；新增题目在旧答卷中无数据，统计时计为 0 或忽略。与第一步「发布后题目变更」规则一致。

---

## 二、REST API 设计（第二步新增与变更）

### 2.1 问卷设置扩展

| 方法 | 路径 | 说明 |
|------|------|------|
| PUT | /api/surveys/:id | 请求体可含第二步设置：**pagination_mode**, **page_size**, **allow_prev_page**, **time_limit_minutes**, **max_responses**（与第一步设置一起或单独接口，依实现约定） |

### 2.2 题目 API 扩展

- **GET /api/surveys/:surveyId/questions**：响应中每题含 **logic**（若有）、**config** 含矩阵 rows/columns、排序 options、日期 dateMin/dateMax 等。
- **POST/PUT 题目**：请求体支持 type 为第二步所有题型；**config** 含上述扩展；**logic** 含 jump、visibility、optionVisibility、optionSource、requiredCondition（结构见 1.4）。

### 2.3 填写端（C 端）扩展

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/fill/:id | 响应增加：**pagination_mode**, **page_size**, **allow_prev_page**, **time_limit_minutes**, **max_responses**, **show_question_nav**；题目列表含 **logic**。若已达最大回收数返回 4xx，message「回收已满」。 |
| GET | /api/fill/:id/draft | 获取当前用户在该问卷下的**草稿答卷**（若有）。需登录；匿名问卷可不提供或按会话标识。Response: 与提交 body 同结构的 **items** 数组（questionId、optionIndex/optionIndices、textValue、scaleValue 等），供填写页回填。若无草稿返回 204 或空 items。 |
| PUT | /api/fill/:id/draft | **每题/每步自动保存**：创建或更新当前用户在该问卷下的草稿。Body 与 POST submit 一致：**items** 数组（当前已填写的全部题目答案）、**durationSeconds** 可选。后端：若不存在草稿则 insert Response(status=DRAFT)+ResponseItem；若存在则按 items 全量覆盖该草稿的 ResponseItem。需登录；匿名问卷可不提供或按会话。 |
| POST | /api/fill/:id/submit | 若当前用户已有该问卷的草稿（status=DRAFT），则校验必填后将该答卷 **status 置为 SUBMITTED**、写入 **submitted_at**，不再新建 Response；若无草稿则按第一步逻辑新建 Response(SUBMITTED)+ResponseItem。Body 同第一步。若**单次限时**，超时拒绝提交并提示。 |

**填写端逻辑计算**：由前端或后端实现「下一题」计算。建议**后端**提供 **GET /api/fill/:id/next** 或提交时由后端按已答题目计算可见题与必填，避免前端与后端规则不一致。若第一步为前端一次性拉取题目后自行计算，第二步可仍由前端根据 logic 计算可见题与跳题；后端提交时校验「当前可见题中必填题已填」即可。

### 2.4 答卷管理

| 方法 | 路径 | 说明 |
|------|------|------|
| PATCH | /api/surveys/:id/responses/:responseId/valid | 标记有效/无效。Body: { "isValid": boolean }。需答卷查看/管理权限。 |
| PUT | /api/surveys/:id/responses/:responseId | 编辑答卷：Body: { "items": [{ questionId, ...答案 }] }。仅更新传入的题目答案；记录 ResponseEditLog。需答卷编辑权限。 |
| GET | /api/surveys/:id/responses/:responseId/edit-log | 某条答卷的修改记录列表（ResponseEditLog）。 |
| GET | /api/surveys/:id/responses | Query 增加 **valid**：all / valid / invalid；**answerFilter**：如 `{ "questionId": 123, "optionIndex": 0 }` 表示「第 123 题选了第 0 项」的答卷。返回 list+total。 |

### 2.5 统计与导出扩展

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/surveys/:id/analytics | Query 可选 **validOnly**=true，仅统计有效答卷。响应中每题 summary 支持第二步题型（矩阵、排序、日期时间等）。 |
| GET | /api/surveys/:id/analytics/grouped | **分类统计**。Query: **dimensionQuestionId**（以哪一题为分类维度）。Response: 按该题每个选项分一组，每组下为各题的统计（结构同单题统计）。 |
| GET | /api/surveys/:id/analytics/cross | **交叉分析**。Query: **rowQuestionId**, **colQuestionId**（行/列题目）。Response: 交叉表（行=row 选项，列=col 选项，单元格=人数或占比）+ 可选图表数据。注明分母与占比口径。 |
| GET | /api/surveys/:id/export | Query: **validOnly**=true 仅有效答卷；**filter**=current 表示与当前答卷列表筛选条件一致（如 valid+answerFilter）。 |

### 2.6 复制问卷

**POST /api/surveys/:id/copy**：复制时包含题目 **logic**、全部第二步题型与 **config**、Survey 的第二步设置（分页、限时、最大回收数、**show_question_nav**）；不复制答卷与 ResponseEditLog。

---

## 三、页面规格详稿（第二步新增与变更）

### 3.1 问卷编辑页 `/surveys/[id]/edit` 扩展

**题目列表（左侧）**  
- 每题可展示**逻辑标识**图标或简短文案，如：「第 2 题 → 跳转」「第 3 题 ← 第 1 题选 A 显示」「选项引用·第 1 题」「条件必填·第 1 题选其他时」。  
- 新题型入口：添加题目时题型下拉增加「下拉单选」「下拉多选」「矩阵单选」「矩阵多选」「矩阵填空」「排序题」「日期题」「时间题」「段落说明」「分页符」。

**题目编辑区（右侧）**  
- **逻辑配置**（每题可选）：  
  - **跳题**：仅单选/下拉单选。每选项可设置「选择后 → 跳转到第 N 题」或「选择后 → 结束答卷」；未配置则顺序下一题。  
  - **题目显隐**：当前题「显示条件」：选择前面某题（可多题）及选项，逻辑与/或/非；默认显示/默认不显示。  
  - **选项显隐**：当前题为单选/多选/下拉时，可为部分选项设置「显示条件」（依赖前题选项）。  
  - **选项引用**：当前题为单选/多选/下拉时，可选「选项来源于前面某题（多选/多选下拉）」；编辑时展示来源题选项，可补充「其他」等。  
  - **条件必填**：当前题「当某题满足某条件时本题必填」；条件可为单条件或多条件（与/或/非）。  
- **检查全部逻辑**（对标问卷星）：编辑页提供入口「检查全部逻辑」，集中展示已配置的跳题、题目显隐、选项显隐、选项引用、条件必填等，便于排查与修正。
- **矩阵题**：行/列编辑（行标签、列标签列表，增删改排序）；**行随机/列随机**、**每行必选或指定行必选**（参考问卷星）。
- **排序题**：选项列表同单选；**选项随机**；说明「填写时拖拽或点选排序」（参考问卷星）。
- **日期题**：**日期范围**（dateMin/dateMax，参考问卷星日期题范围控制）。
- **时间题**：可选时间格式（如 HH:mm）。
- **段落说明**：正文内容（content）；分页符无额外配置。
- **时间题**：时间选择器配置。  
- **段落说明**：富文本或纯文本内容，不收集答案。  
- **分页符**：仅占位，可带说明「填写时在此分页」。

**保存与发布**  
- 收集中/已暂停时保存逻辑与题目，仍强提示「修改会影响已回收数据与统计，是否继续？」。

### 3.2 问卷设置页 `/surveys/[id]/settings` 扩展

- **分页**：单选「不分页」/「按分页符」/「每 N 题一页」；选「每 N 题一页」时数字输入 N。  
- **允许上一页**：勾选「分页时允许填写者返回上一页」。  
- **单次填写限时**：数字输入（分钟），0 或空表示不限时。  
- **最大回收数**：数字输入，0 或空表示不限制。  
- **显示题目导航**：勾选「填写页显示题目导航」；不勾选则填写页顶部仅显示进度条（若有），不展示题号列表与跳转。

保存后写入 Survey 表（或设置存储）。

### 3.3 填写页 `/fill/[id]` 扩展

**题目导航与进度条（顶部区域）**  
- **进度条**：填写页顶部展示横向进度条，可选「按题目」（已作答题目数/当前可见题目总数）或「按分页」（当前页/总页数），与问卷星「显示设置」对齐。  
- **题目导航**（当 show_question_nav 为 true 时）：  
  - 在进度条下方或同一区域展示**当前可见题目**的题号列表（或题号+题干缩写）；**不包含**因跳题/显隐对当前作答路径下不可见的题目，避免点击后出现「本题不显示」的歧义。  
  - 每题显示**已填 / 未填**状态（如圆点、勾选、颜色区分）；支持**点击某题跳转**至该题：分页模式下先切换到该题所在页再滚动定位到该题，一页到底模式直接滚动到该题。  
  - 移动端题多时导航可收起为「题号」或「导航」入口，展开为浮层或侧栏，避免占满首屏。  
- **实现约定**：导航列表随当前已答结果与 logic 实时更新（某题因前面答案变化变为不可见时，从导航中移除或灰显）；段落/分页符不参与「已填」统计，仅占位或按需展示题号。

**每题/每步自动保存到后端**  
- 进入填写页时：若已登录且问卷支持草稿，**GET /api/fill/:id/draft**；若有草稿则用返回的 items 回填表单，使填写者可续填。  
- 作答过程中：**每题或每步（如翻页、题目失焦）** 将当前已填答案汇总为 items，调用 **PUT /api/fill/:id/draft** 保存到后端；建议前端**防抖**（如 300～500ms）或「翻页时保存」「失焦时保存」以控制请求频率。  
- 点击「提交」时：先做必填校验；通过后 **POST /api/fill/:id/submit**；若后端发现已有该用户草稿则将其置为 SUBMITTED 并写 submitted_at，否则新建答卷。提交成功后草稿被消耗，不再存在。

**逻辑与分页**  
- 进入时拉取题目与 logic；**按题序与当前已答计算可见题**（跳题、题目显隐、选项显隐、选项引用生成的选项列表）。  
- **分页**：若问卷设置分页，则按页展示；底部「上一页」「下一页」（allow_prev_page 为 false 时隐藏「上一页」）；最后一页为「提交」。  
- **必填校验**：仅对**当前可见题**中满足 requiredCondition 的题做必填校验；被隐藏题不校验。

**限时**  
- 若 time_limit_minutes 存在，进入填写页开始倒计时；超时后禁止提交并提示「已超时」。

**回收已满**  
- GET 填写元数据若返回 4xx「回收已满」，页面展示「问卷回收数量已达上限」，不展示题目。

**新题型控件**  
- 下拉单选/多选：`<select>` 单选或多选。  
- 矩阵单选：行×列，每行单选。  
- 矩阵多选/填空：行×列多选或每格输入。  
- 排序题：拖拽或点选排序。  
- 日期/时间：日期选择器、时间选择器。  
- 段落：仅展示文案。  
- 分页符：仅分页，无控件。

### 3.4 答卷列表 `/surveys/[id]/responses` 扩展

- **筛选**：Tab 或下拉「全部 / 仅有效 / 仅无效」；**按答案筛选**：选择题目与选项（如「第 2 题 = 选项 A」），列表只显示符合条件的答卷。  
- **行操作**：「标记无效」/「标记有效」；「编辑」→ 弹窗或侧栏编辑该条答卷（修改某题答案），保存后写 ResponseEditLog。  
- **单条详情**：可展示「修改记录」入口，查看该条答卷的编辑历史（谁、何时、哪题、原值/新值）。

### 3.5 统计分析 `/surveys/[id]/analytics` 扩展

- **单题统计**：与第一步一致，扩展支持第二步题型（矩阵、排序、日期时间等）；顶部可勾选「仅统计有效答卷」。  
- **分类统计**：新增入口「分类统计」；先选择**分类依据题**（如性别），再展示「按该题每个选项分组」后的各组单题统计（可 Tab 或下拉切换组）。  
- **交叉分析**：新增入口「交叉分析」；选择**两题 A、B**；展示交叉表（A 选项为行，B 选项为列，单元格为人数或占比）；可选图表（如堆叠柱状图）；注明分母与占比口径。

### 3.6 导出

- 导出前可选「全部答卷」「仅有效答卷」「当前筛选结果」（与答卷列表当前 valid + answerFilter 一致）。  
- **Excel 格式**（对标问卷星）：可选**按选项序号**、**按选项文本**、**按选项分数**（导出值为题目/选项预设分数）；列与第一步一致，按当前题目结构；被删题目列留空或标「题目已删除」；未作答（跳过）标「未作答（已跳过）」或留空。

### 3.7 复制问卷

复制后新问卷含**全部题目、logic、第二步题型 config、分页/限时/最大回收数/显示题目导航设置**；不复制答卷与修改记录。

---

## 四、前端组件与关键流程

### 4.1 路由（沿用第一步，无新增页面）

编辑页、设置页、答卷列表、统计分析、填写页均为第一步已有路由；第二步在其上扩展能力。

### 4.2 可复用组件建议（第二步新增/扩展）

- **LogicEditor**：单题逻辑配置（跳题、显隐、选项显隐、选项引用、条件必填）；内部可拆 JumpRuleEditor、VisibilityConditionEditor、OptionVisibilityEditor、OptionSourcePicker、RequiredConditionEditor。  
- **MatrixRowColEditor**：矩阵题行/列标签编辑。  
- **ConditionBuilder**：多条件与/或/非组合（选择前题、选项、逻辑符）。  
- **FillPageRouter**：填写页内根据 logic 与分页计算当前可见题与下一题/上一题；驱动分页与提交。  
- **FillDraftSync**：填写页内监听题目答案变化，防抖后调用 PUT draft 保存；进入时调用 GET draft 回填（若有）。  
- **FillQuestionNavigator**：填写页顶部题目导航，展示当前可见题题号、已填/未填状态，点击跳转到该题；与 FillPageRouter 共享可见题与作答状态。  
- **FillProgressBar**：填写页顶部进度条（按题目或按分页）；可与题目导航同区展示。  
- **ResponseFilter**：答卷列表按有效/无效、按答案筛选的 UI。  
- **ResponseEditModal**：编辑单条答卷，提交后刷新列表与修改记录。  
- **GroupedAnalytics**：分类统计（选维度题 → 各组统计）。  
- **CrossAnalytics**：交叉分析（选两题 → 交叉表+图表）。  
- **ExportOptionDialog**：导出前选择全部/仅有效/当前筛选。

### 4.3 关键流程（第二步）

1. **配置逻辑**：编辑页选题 → 右侧展开逻辑配置 → 配置跳题/显隐/选项显隐/选项引用/条件必填 → 保存。  
2. **分页与限时**：设置页配置分页方式、允许上一页、单次限时、最大回收数 → 保存。  
3. **填写**：打开链接 → 若有草稿则回填 → 顶部题目导航与进度条（若开启）→ 按 logic 与分页展示题目 → 每题/每步自动保存到后端（草稿）→ 可点击导航跳题 → 分页切换/倒计时 → 提交（校验后草稿转已提交或新建答卷）。  
4. **答卷管理**：答卷列表筛选有效/无效、按答案筛选 → 标记无效/有效 → 编辑某条 → 保存并写修改记录。  
5. **分类统计**：统计分析页 → 分类统计 → 选维度题 → 查看各组单题统计。  
6. **交叉分析**：选两题 → 查看交叉表与图表。  
7. **导出**：选择全部/仅有效/当前筛选 → 导出 Excel。

---

## 五、交付与实现顺序建议

1. **数据模型与迁移**：Survey 新增字段；SurveyQuestion 增加 logic、config 扩展；Response 增加 **status**（DRAFT/SUBMITTED）、**submitted_at**、is_valid；新建 ResponseEditLog 表；ResponseItem 支持新 value_type 与取值。  
2. **题目与逻辑**：编辑端新题型 CRUD、logic 配置 UI、矩阵行/列；保存/读取 logic 与 config。  
3. **填写端**：logic 计算引擎（可见题、下一题、必填条件）；分页、限时、回收已满；**草稿拉取与每题/每步自动保存**（GET/PUT draft、提交时草稿转 SUBMITTED）；新题型控件与提交结构。  
4. **问卷设置**：分页、限时、最大回收数设置页与 API。  
5. **答卷管理**：标记有效/无效、编辑答卷、修改记录、按答案筛选 API 与列表/详情 UI。  
6. **统计与导出**：分类统计、交叉分析 API 与页面；导出仅有效/当前筛选。  
7. **复制**：复制时含 logic、全部题型与第二步设置。

---

## 六、对《问卷第二步-范围说明》的覆盖检查

| 范围说明章节 | 覆盖情况 | 详稿对应位置 |
|--------------|----------|--------------|
| **二、逻辑设置** | ✓ | 1.4 logic 结构（跳题、题目显隐、选项显隐、选项引用、必填逻辑、多条件）；2.2 题目 API；3.1 编辑页逻辑配置 |
| **三、题型新增** | ✓ | 1.3 type 与 config 扩展（下拉、矩阵、排序、日期、时间、段落、分页符）；3.1 编辑区、3.3 填写页控件 |
| **四、问卷级设置新增** | ✓ | 1.2 Survey 扩展；2.1 设置 API；3.2 设置页 |
| **五、答卷管理** | ✓ | 1.5–1.6 Response.is_valid、ResponseEditLog；2.4 答卷 API；3.4 答卷列表与编辑 |
| **六、分类统计与交叉分析** | ✓ | 2.5 分类/交叉 API；3.5 分类统计与交叉分析入口与展示 |
| **七、编辑页、填写页与复制** | ✓ | 3.1 题目列表逻辑标识、逻辑配置、矩阵与新题型；3.3 分页/限时/回收满、**草稿回填与每题/每步自动保存**；3.7 复制含逻辑与题型 |
| **九、第二步交付清单** | ✓ | 全文按清单项拆解为数据模型、API、页面与组件 |

**结论**：本设计详稿在功能上覆盖《问卷第二步-范围说明》中第二步全部交付项；逻辑与题型、分页与限时、答卷管理、分类与交叉分析、复制范围均已落实到表结构、接口与页面规格。实施时以本稿与范围说明为准，第一步已有能力沿用《问卷第一步-设计详稿》。
