# 问卷第一步 - 实现对照检查

> 对照《问卷第一步-范围说明.md》与《问卷第一步-设计详稿.md》对当前代码的覆盖情况。检查时间：按代码库当前状态。

---

## 一、问卷基础与状态（范围说明 一）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 问卷标题 | 必填，单行 | ✅ 设置页编辑，必填 |
| 问卷说明/前言 | 选填，纯文本 | ✅ 设置页多行输入 |
| 问卷状态 | 草稿 / 收集中 / 已暂停 / 已结束 | ✅ 后端 DRAFT/COLLECTING/PAUSED/ENDED，前端列表与操作一致 |
| 归属与权限 | 编辑/查看/导出/删除/复制**按角色权限**，有相应权限的用户可操作 | ⚠️ **当前仅按创建者**（requireCreator），未按角色权限扩展；文档要求「有相应权限的用户可操作」 |
| 我的问卷列表 | 状态筛选、关键词搜索、按时间排序 | ✅ 全部/草稿/收集中/已暂停/已结束筛选，关键词搜索，最近更新/最近创建排序 |
| 问卷操作 | 保存草稿、发布、暂停回收、重新开启、结束、复制、删除 | ✅ 均有对应 API 与前端入口 |

---

## 二、题目与题型（范围说明 二；详稿 1.3、2.3、3.2）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 单选题 | 选一项；选项增删改、排序；支持「其他」+ 填空 | ✅ 选项增删改、**拖拽排序**；hasOtherOption + otherAllowFill（与详稿 per-option isOther/allowFill 等价） |
| 多选题 | 选多项；最少/最多选 N 项；选项增删改、排序；其他+填空 | ✅ minChoices/maxChoices；选项拖拽排序；其他+填空 |
| 填空题 | 单行/多行；占位提示；必填 | ✅ SHORT_TEXT/LONG_TEXT；config.placeholder；必填勾选 |
| 量表题 | 1–N 可配置；左右端点文案 | ✅ scaleMin/scaleMax、scaleLeftLabel/scaleRightLabel |
| 题目标题、题目说明、必填 | 题干必填，说明选填，必填可勾选 | ✅ |
| 题目序号 | 自动编号，随增删/排序变化 | ✅ 题目列表为顺序展示，填写页为题目顺序 |
| 选项编辑与排序 | 增删改、排序（上移下移**或**拖拽） | ✅ **仅拖拽排序**（上移下移已按后续需求移除） |
| 题目操作 | 新增、复制、删除、排序 | ✅ 添加题目、复制题目、删除题目、拖拽排序；收集中调整题目顺序有确认提示 |

---

## 三、问卷级设置（范围说明 三；详稿 1.4、3.3）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 防重复 | 每人限填一次，按登录 user_id | ✅ limit_once_per_user，按 user_id 校验 |
| 匿名 | 允许匿名 / 仅登录可填 | ✅ allow_anonymous；匿名时不记 user_id |
| 开始时间、结束时间 | 选填；未到/已过时禁止填写并提示 | ✅ start_time/end_time；后端 4002/4003，前端展示 error.message |
| 感谢语 | 提交成功后展示 | ✅ thank_you_text，填写页提交成功后展示 |

---

## 四、编辑页布局与操作（范围说明 四；详稿 3.2）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 编辑页布局 | 左侧题目列表，右侧题目编辑；**顶部**问卷标题、问卷说明 | ⚠️ **问卷标题、问卷说明已合并到设置页**（按后续产品需求），编辑页仅题目与发布入口 |
| 保存与发布 | 保存草稿、发布（草稿→收集中） | ✅ 设置页保存标题/说明与设置；编辑页发布入口 |
| 发布后题目修改 | 收集中/已暂停可增删改题目；强提示「会影响已回收数据与统计，是否继续？」 | ✅ 修改题目（含选项）、删除题目、复制题目、调整题目顺序均有确认（收集中/已暂停时） |

---

## 五、发放与填写（范围说明 五；详稿 2.5、2.6、3.7）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 问卷链接 | 固定链接；发布后可复制链接 | ✅ /fill/[id]；列表页卡片有「复制填写链接」按钮（getFillUrl） |
| 填写入口 | 我的问卷仅「我创建的」；填写通过链接打开 | ✅ 列表按 creatorId；填写页 /fill/[id] |
| 填写页展示与提交 | 按题序展示；必填校验；提交后感谢语 | ✅ Survey.js 渲染；必填校验；感谢语展示 |
| 异常提示 | 问卷已删除、未到开始时间、已截止、已填过等统一明确提示 | ✅ 后端 ErrorCode 对应 message，填写页 GET 失败时展示 error.message |

---

## 六、答卷与统计导出（范围说明 六；详稿 2.7、3.5、3.6）

| 功能点 | 范围/详稿要求 | 实现情况 |
|--------|----------------|----------|
| 答卷列表 | 提交时间、用时、部分题目答案摘要；分页；点击查看详情 | ✅ 提交时间、用时、摘要（前两题）；分页；单条详情（逐题答案） |
| 单题统计 | 单选/多选：人数占比、饼图或柱状图；量表：平均分与分布；填空：答案列表 | ✅ 单选/多选饼图+柱状图（ECharts）；量表平均分+分布；填空答案列表；不做词云 |
| 导出 | **导出 Excel**（范围说明、详稿 2.7） | ⚠️ **当前为导出 CSV**（text/csv），非 Excel；功能为「全部答卷」导出，范围一致 |

---

## 七、数据模型与 API（详稿 一、二）

| 项目 | 详稿要求 | 实现情况 |
|------|----------|----------|
| Survey 主键 | 雪花或自增 | ✅ 已改为 **VARCHAR(36) UUID**（按后续需求） |
| Survey 字段 | 含设置字段（防重复、匿名、时间、感谢语） | ✅ 表与实体一致 |
| SurveyQuestion.config | 含 options、minChoices、maxChoices、placeholder、scaleMin/Max、scaleLeft/RightLabel 等 | ✅ 单选/多选/填空/量表均使用 config JSON |
| 选项标识 | 选项用 config.options 下标（0 起） | ✅ optionIndex/optionIndices、ResponseItem 存 option_index/option_indices |
| Response / ResponseItem | 答卷与答卷项结构 | ✅ 与详稿 1.5、1.6 一致 |
| 问卷/题目/设置/填写/答卷/统计 API | 详稿 2.2–2.7 | ✅ 路径与语义一致；问卷设置合并在 Survey，PUT 基础信息 + PUT settings |

---

## 八、交付清单（范围说明 八）勾选

| 项 | 状态 |
|----|------|
| 问卷：表结构；CRUD；标题、说明、状态、创建者、时间、匿名、感谢语；列表筛选排序；发布/暂停/恢复/结束/复制/删除 | ✅ |
| 题目：表结构；题型单选/多选/填空/量表；题干、必填、选项（含其他+填空）、多选上下限、量表 1–N 与端点文案；排序、增删改复制 | ✅ |
| 问卷设置：防重复、匿名、开始/结束时间、感谢语 | ✅ |
| 编辑页：左侧题目列表 + 右侧题目编辑；问卷标题/说明在**设置页**；保存草稿；发布前校验 | ✅（标题/说明位置按后续需求） |
| 填写：固定链接；按题渲染、必填校验、提交；感谢页；未到开始/已截止/防重复等提示 | ✅ |
| 我的问卷：我创建的列表与状态筛选；填写通过链接 | ✅ |
| 答卷：提交落库；列表分页/摘要/单条详情；单题统计（单选多选/量表/填空）；导出（当前 CSV） | ✅（导出格式见上） |
| 权限：编辑/查看/导出/删除**按角色权限** | ⚠️ 当前仅创建者，见上 |

---

## 九、差异汇总与建议

1. **权限**  
   - 范围说明与详稿：编辑/查看/导出/删除/复制等按**角色权限**，有相应权限的用户可操作。  
   - 当前：仅校验**创建者**（requireCreator）。  
   - 建议：若需严格符合文档，需增加「问卷」相关权限点，并在问卷各接口中按角色权限校验（不限于创建者）。

2. **导出格式**  
   - 范围说明与详稿：**导出 Excel**。  
   - 当前：**导出 CSV**（text/csv）。  
   - 建议：若需严格符合文档，可改为生成 .xlsx（或保留 CSV 并在文档中注明第一步先做 CSV）。

3. **编辑页顶部标题/说明**  
   - 详稿 3.2：编辑页**顶部**有问卷标题、问卷说明。  
   - 当前：标题、说明在**设置页**编辑（为后续产品需求调整）。  
   - 建议：视为按后续需求的实现，若需与详稿完全一致可再在编辑页顶部增加只读展示或跳转设置页入口。

4. **题目排序方式**  
   - 详稿：支持「上移/下移**或**拖拽排序」。  
   - 当前：仅**拖拽排序**（上移下移已移除）。  
   - 建议：满足「或」的其一即可，当前实现可保留。

---

**结论**：当前实现**在功能上基本完整覆盖**《问卷第一步-范围说明》与《问卷第一步-设计详稿》中第一步范围；主要差异为：**权限按角色未做（当前仅创建者）**、**导出为 CSV 而非 Excel**，以及**编辑页问卷标题/说明在设置页**（属后续需求调整）。其余数据模型、API、页面与流程与两份文档一致。
