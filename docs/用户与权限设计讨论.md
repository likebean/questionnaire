# 用户、角色、权限设计

单校部署、无多租户。目标：能登录、能按「谁」做归属与数据范围，后续可接院系与审计。

---

## 一、概念与结论

| 概念 | 含义 | 在本系统里的作用 |
|------|------|------------------|
| **用户（User）** | 自然人/人员 | 业务主体：创建问卷、填答、归属院系、挂角色；**不存登录名和密码**。 |
| **账号（Account）** | 登录凭证 | 用 **login_id + auth_source** 表示（与 ai-plugin 一致）。本地：login_id + auth_source=local + password_hash；CAS：login_id（学号/工号）+ auth_source=cas。一用户可多账号。 |
| **角色** | 身份标签 | 校管/院系管理员/普通用户；决定操作权限与数据范围（本校/本院系/本人）。 |
| **权限** | 具体操作点 | 权限表（**resource_type + action + data_scope**）挂到角色；数据范围由 **permission.data_scope** 决定。 |

**已定方案**：建**用户表、账号表、角色表、权限表、院系表**；用户与账号分离（账号 → 用户多对一）；一人多角色，权限取并集、数据范围按当前操作匹配的 permission.data_scope（多条取最大）；院系树形、层级不限制；**数据范围在 permission 表，首版不用 resource_id/condition_expr**。**删除**：全表**物理删除**（无 status、无 deleted 字段）。

---

## 二、表结构（定稿）

### 2.1 院系表 `department`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键 |
| code | varchar(64) | 院系编码，唯一，便于与学校同步 |
| name | varchar(128) | 名称 |
| parent_id | bigint | 父院系 id，0 或 NULL 表示根 |
| level | int | 层级（可选） |
| sort | int | 同级排序 |
| created_at, updated_at | datetime | |

树形通过 parent_id 递归或内存建树；**层级不限制深度**。单校无 tenant_id。删除用**物理删除**（无 deleted 字段）。

### 2.2 角色表 `role`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键，自增 |
| code | varchar(50) | 唯一，如 SCHOOL_ADMIN, DEPT_ADMIN, USER |
| name | varchar(100) | 显示名 |
| description | varchar(500) | 可选 |
| sort | int | 排序（问卷保留；ai-plugin 无此字段） |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

单校无 tenant_id。**数据范围**：在 permission 表用 data_scope 表示（见 2.3），按当前操作的权限取 scope，结合 user.department_id 拼 WHERE。

### 2.3 权限表 `permission`（首版简化：仅 resource_type + action + data_scope）

无 code 字段；**首版去掉 resource_id、condition_expr**，只用 **resource_type + action + data_scope** 标识；单校无 tenant_id。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键，自增 |
| name | varchar(100) | 权限名称（展示用） |
| **resource_type** | varchar(50) | 资源类型：survey / response / user / dept / role 等 |
| **action** | varchar(50) | 操作：view / create / edit / delete / export / use 等 |
| **data_scope** | varchar(20) | 数据范围：SCHOOL / DEPARTMENT / SELF |
| description | varchar(500) | 可选 |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

- **唯一约束**：**(resource_type, action, data_scope)**（单校不加 tenant_id）。同一操作可有不同范围的多条（如 response+export+SELF、response+export+DEPARTMENT）。
- 判断：当前用户 → user_role → 角色 → role_permission → permission；按当前请求的 (resource_type, action) 匹配权限，取 **data_scope**（多条时取最大：SCHOOL > DEPARTMENT > SELF），再结合 user.department_id 拼 WHERE；**多角色权限取并集**。

### 2.4 角色-权限关联表 `role_permission`（与 ai-plugin 一致）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键，自增 |
| role_id | bigint | 角色 id |
| permission_id | bigint | 权限 id |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

- **唯一约束**：**(role_id, permission_id)**。

### 2.5 用户表 `user`（人员，不存登录凭证）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | **varchar(50)** PK | 主键（与 ai-plugin 一致，便于与外部 ID 对齐） |
| nickname | varchar(64) | 昵称/姓名（或与 ai-plugin 一致用 name） |
| email | varchar(128) | 可选 |
| phone | varchar(32) | 可选，**不加唯一约束** |
| identity_type | varchar(32) | FACULTY / STUDENT / OTHER |
| department_id | bigint | 所属院系 id，可空 |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

角色通过 user_role，院系通过 department_id。删除用**物理删除**（无 status、无 deleted）。

### 2.6 账号表 `account`（login_id + auth_source，与 ai-plugin 对齐）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键，自增 |
| user_id | **varchar(50)** | FK → user.id |
| **login_id** | varchar(100) | 本地=用户名/手机号，CAS=学号/工号 |
| **auth_source** | varchar(20) | local / cas |
| password_hash | varchar(255) | local 必填，cas 为空 |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

- **唯一约束**：**(login_id, auth_source)**。删除用**物理删除**（无 status、无 deleted）。
- **无注册**：用户全部来自 **CAS 与学校已有系统**；不提供自注册。首次 CAS 登录时建 user + account(auth_source=cas)，或由学校系统同步/导入。
- **登录**：CAS 用 (login_id, auth_source=cas) 查 account，无则首次建 user + account(cas)；若保留本地账号仅用于开发/测试，则 local 用密码校验。

### 2.7 用户-角色关联表 `user_role`（与 ai-plugin 一致）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint PK | 主键，自增 |
| user_id | varchar(50) | 用户 id |
| role_id | bigint | 角色 id |
| created_at, updated_at | datetime | |
| creator, updator | varchar(50) | 可选 |

- **唯一约束**：**(user_id, role_id)**（单校无 tenant_id）。
- 一人多角色；**数据范围取最大**（SCHOOL > DEPARTMENT > SELF）。

---

## 三、权限清单（首版建议，按 resource_type + action + data_scope）

种子数据按 **(resource_type, action, data_scope)** 建 permission；鉴权时按当前操作的 (resource_type, action) 匹配用户权限，取 data_scope（多条取最大）。

| resource_type | action | data_scope | name | 说明 |
|---------------|--------|------------|------|------|
| survey | view | SCHOOL / DEPARTMENT / SELF | 查看问卷 | 按角色配不同 scope |
| survey | create | SELF | 创建问卷 | 新建 |
| survey | edit | SELF | 编辑问卷 | 编辑、删除 |
| survey | publish | SELF | 发布/结束问卷 | 发布、暂停、结束 |
| response | view | SCHOOL / DEPARTMENT / SELF | 查看答卷 | 按角色配不同 scope |
| response | export | SELF 或 DEPARTMENT | 导出答卷 | 本人或本院系（不同角色挂不同 permission） |
| response | edit | SELF | 编辑答卷 | 若做 |
| user | view | SCHOOL / DEPARTMENT | 查看用户 | 校管/院系管理用 |
| user | manage | SCHOOL | 管理用户 | 校管 |
| dept | view | SCHOOL / DEPARTMENT | 查看院系 | 院系树、列表 |
| dept | manage | SCHOOL | 管理院系 | 校管 |
| role | view | SCHOOL | 查看角色 | 角色及权限 |
| role | manage | SCHOOL | 管理角色 | 校管 |

校管挂 SCHOOL 范围；院系管理员挂 DEPARTMENT（如 survey/view、response/view 为 DEPARTMENT，response/export 可为 SELF 或 DEPARTMENT）；普通用户挂 SELF。**数据范围**由 permission.data_scope + user.department_id 计算。

---

## 四、数据范围规则

| data_scope | 问卷列表 / 答卷 | 实现 |
|------------|-----------------|------|
| SCHOOL | 本校全部 | 不加创建人/院系限制 |
| DEPARTMENT | 本院系及子院系 | WHERE department_id IN (本院系及子院系列表)；子院系用递归或内存树，层级不限制 |
| SELF | 本人创建的 / 本人问卷下的答卷 | WHERE creator_id = 当前用户（问卷）；答卷通过问卷归属过滤 |

实现：按当前请求的 (resource_type, action) 取用户拥有的 permission，得到 **data_scope**（多条取最大），再结合 user.department_id 拼 WHERE。

---

## 五、身份类型 identity_type

- **取值**：FACULTY（教职工）、STUDENT（学生）、OTHER。
- **用途**：展示（个人资料、答卷填写人）；规则（如仅教职工可创建问卷）。
- **来源**：CAS 或学校 API 同步时写入；无自注册。

**待定**：权限点清单是否增删；院系管理员是否强制 department_id 非空。

---

## 六、CAS 与学校人员系统对接

### 6.1 登录方式并存

- **本地**：account(auth_source=local, login_id, password_hash) → user。
- **CAS**：account(auth_source=cas, login_id=学号/工号) → user；无密码，认证由 CAS 完成。
- 同一 user 可有多条 account（local + cas），登录任一号得到同一 user。

### 6.2 CAS 登录流程

1. 用户选「统一身份登录」→ CAS 带 Ticket 回调。
2. 用 Ticket 换 **login_id**（学号/工号）。
3. 查 account(auth_source=cas, login_id)：  
   - **已有**：取 user_id → user，可选更新 nickname、identity_type、department_id；建 Session/JWT。  
   - **首次**：建 user（信息来自 CAS 属性或学校 API）→ 建 account(cas) → 分配角色（见 6.5）→ 建 Session/JWT。
4. **方式 A**：CAS 属性带姓名、身份、院系代码 → 写/更新 user，院系 code 映射 department_id。  
5. **方式 B**：仅 login_id → 调学校 API 拉取姓名、院系、身份 → 写/更新 user、按需补 department。

### 6.3 学校侧信息需求

| 用途 | 最少 | 说明 |
|------|------|------|
| 唯一标识 | login_id（学号/工号） | 对应 account.login_id, auth_source=cas |
| 姓名 | nickname | 个人中心、创建者、答卷填写人 |
| 身份类型 | identity_type | 规则、统计 |
| 院系 | 院系代码（及名称） | 用户归属、数据范围 |

来源：CAS 属性（方式 A）或学校用户/人事 API（方式 B）。

### 6.4 院系对齐

- 院系表 **code 与学校编码一致**。
- 同步：学校 API 定时同步，或登录时按需创建；层级不限制。

### 6.5 角色由本系统管理

角色通过 **user_role** 分配，本系统维护；不依赖学校返回角色。可选：学校 API 返回「是否院系管理员」时首次登录自动挂 DEPT_ADMIN。

**结论**：身份与院系来自 CAS/学校，角色与权限在本系统。

---

## 七、与 ai-plugin 的对齐说明（ai_plugin 库）

问卷表结构与 ai-plugin 对齐的结论：

| 表 | 对齐要点 |
|------|------|
| **user** | id 用 **varchar(50)**；phone **不唯一**；无 status/deleted；**物理删除**；creator/updator。问卷独有：nickname、email、identity_type、department_id。 |
| **account** | **login_id + auth_source**，唯一 (login_id, auth_source)；user_id varchar(50)；无 status/deleted；**物理删除**；creator/updator。 |
| **role** | 单校无 tenant_id；唯一 code；**物理删除**。 |
| **permission** | **首版简化**：无 code；**resource_type + action + data_scope**（去掉 resource_id、condition_expr）；唯一 (resource_type, action, data_scope)；单校无 tenant_id。与 ai-plugin 的完整模型可后续扩展。 |
| **user_role** | **自增 id 主键 + 唯一 (user_id, role_id)**；created_at、updated_at、creator、updator；单校无 tenant_id。 |
| **role_permission** | **自增 id 主键 + 唯一 (role_id, permission_id)**；created_at、updated_at、creator、updator。 |

**下一步**：Flyway 建表、种子数据（角色+权限+角色权限+院系）、CAS 登录/登出/当前用户接口（无注册），预留学校 API 同步入口。
