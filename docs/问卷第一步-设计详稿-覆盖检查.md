# 问卷第一步 - 设计详稿覆盖检查

> 对照《问卷第一步-设计详稿.md》对当前代码的覆盖情况。✓ 已实现；△ 部分实现；✗ 未实现。

---

## 一、数据模型

| 设计项 | 状态 | 说明 |
|--------|------|------|
| 1.1 Survey–Question–Response–ResponseItem 关系 | ✓ | 表与实体齐全 |
| 1.2 Survey：id, title, description, status, creator_id, created_at, updated_at | ✓ | 实体与迁移一致 |
| 1.2 deleted_at（软删除） | △ | 设计为「若采用」；当前物理删除 |
| 1.3 SurveyQuestion：全部字段 + config JSON | ✓ | 含 options/minChoices/maxChoices/scaleMin 等 |
| 1.4 问卷设置合并到 Survey 表 | ✓ | limit_once_per_user, allow_anonymous, start_time, end_time, thank_you_text |
| 1.5 Response / 1.6 ResponseItem | ✓ | 字段与设计一致，optionIndex/optionIndices |

---

## 二、REST API

### 2.2 问卷

| 接口 | 状态 | 说明 |
|------|------|------|
| GET /api/surveys | ✓ | status, keyword, page, pageSize, sort；Response: { list, total } |
| POST /api/surveys | ✓ | Body: title, description?；返回 Survey |
| GET /api/surveys/:id | ✓ | 详情含题目、设置 |
| PUT /api/surveys/:id | ✓ | 基础信息 title, description |
| PUT /api/surveys/:id/settings | ✓ | 单独更新设置 |
| POST publish / pause / resume / end / copy | ✓ | 状态机正确 |
| DELETE /api/surveys/:id | ✓ | 物理删除 |
| 发布校验：至少一题、题干非空、单选/多选至少一选项 | ✓ | publish() 已实现 |

### 2.3 题目

| 接口 | 状态 | 说明 |
|------|------|------|
| GET/POST /api/surveys/:surveyId/questions | ✓ | 按 sort_order 返回 |
| PUT .../questions/:questionId | ✓ | 题干、题型、必填、config |
| PUT .../questions/order | ✓ | Body: questionIds（数组） |
| POST .../questions/:questionId/copy | ✓ | 插入原题后 |
| DELETE .../questions/:questionId | ✓ |  |
| 排序 Body「fromIndex, toIndex」 | △ | 仅实现 questionIds 数组 |

### 2.4 问卷设置

| 设计 | 状态 | 说明 |
|------|------|------|
| 设置合并在 Survey，GET 详情含设置 | ✓ | SurveyDetailVO 含全部设置字段 |
| 更新设置 | ✓ | PUT /api/surveys/:id/settings |

### 2.5 发放（链接）

| 接口 | 状态 | 说明 |
|------|------|------|
| GET /api/surveys/:id/fill-url | ✓ | Response: { fillUrl: "/fill/:id" }，前端拼接完整 URL |
| 短码 /api/s/:shortCode | △ | 第一步未做 |

### 2.6 填写端

| 接口 | 状态 | 说明 |
|------|------|------|
| GET /api/fill/:id | ✓ | 元数据含 thankYouText；4xx 与 code/message |
| POST /api/fill/:id/submit | ✓ | 校验 + 必填/选项/量表；感谢语由 GET 元数据带回 |

### 2.7 答卷与统计

| 接口 | 状态 | 说明 |
|------|------|------|
| GET /api/surveys/:id/responses | ✓ | 分页，list 含 submittedAt, durationSeconds, summary |
| GET /api/surveys/:id/responses/:responseId | ✓ | 逐题答案文案 |
| GET /api/surveys/:id/analytics | ✓ | 单选/多选 options 统计、量表 avg+distribution、填空 list |
| GET /api/surveys/:id/export | ✓ | CSV 文件流（Excel 可打开） |

---

## 三、页面规格

| 页面/功能 | 状态 | 说明 |
|-----------|------|------|
| 3.1 我的问卷列表 /surveys | ✓ | 状态筛选、关键词搜索、排序、表格列、行操作（设计/设置/答卷/统计/复制链接/复制/删除）、创建→edit、空状态 |
| 3.2 编辑页 /surveys/[id]/edit | ✓ | 顶部标题/说明、保存草稿/保存/发布；左题目列表、右题目编辑；题干、题目说明、题型、必填、选项、多选上下限、填空占位、量表刻度与端点；收集中/已暂停保存与删题强确认 |
| 3.3 设置页 /surveys/[id]/settings | ✓ | 防重复、匿名、开始/结束时间、感谢语、填写链接+复制 |
| 3.4 发放（链接展示） | ✓ | 列表「复制链接」+ 设置页填写链接区块 |
| 3.5 答卷列表 /surveys/[id]/responses | ✓ | 面包屑、表格、分页、查看详情弹窗、空状态 |
| 3.6 单题统计与导出 /surveys/[id]/analytics | ✓ | 面包屑、按题统计表格、导出 Excel（CSV） |
| 3.7 填写页 /fill/[id] | ✓ | 4xx 错误区、标题/说明、按题渲染、必填、提交、感谢语 |

**编辑页**：题目拖拽/上移下移为 △（当前仅通过题目列表选题，排序依赖后端 questionIds；未做前端拖拽）。

---

## 四、权限与约定

| 设计 | 状态 | 说明 |
|------|------|------|
| 鉴权：需登录接口带 Cookie/Authorization | ✓ | Spring Security 保护 /api/surveys/** |
| 问卷按角色权限 | △ | 当前按创建者（creator_id），与设计「按角色」可后续扩展 |

---

## 五、结论

设计详稿中**数据模型、全部 REST API、全部页面规格**已实现；仅以下为部分或可选：

- 软删除（设计「若采用」）、短链、排序 fromIndex/toIndex、编辑页拖拽排序、权限按角色。

运行测试：后端 `cd api && ./mvnw test`；E2E `cd web && npm run test:e2e`（依赖 API 的用例在后端未启动时会自动 skip）。
