# 问卷第一步 - 代码修改指导清单

> **原则**：第一步范围说明与交付清单中列出的功能，在本阶段**完整实现**，不遗留到下一步。本文档合并「第一步范围内当前代码缺失」与「当前实现与问卷星有差异需对齐」两项，作为代码修改的指导列表。  
> 依据：《问卷第一步-范围说明.md》《问卷第一步-设计详稿.md》、docs/wjx-help 问卷星对标。

---

## 一、第一步范围内当前代码缺失（必须补齐）

### 1.1 问卷标题：\n 换行与主标题+副标题

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 范围说明 §1、§八交付清单 | 问卷标题必填；支持 **\n** 换行、**主标题+副标题**（编辑时换行处输入 \n，对标问卷星） | 仅单字段 `title`，前端各处均按纯文本展示，无 \n 换行 | **存储**：沿用 `Survey.title`，允许内容包含 `\n`。**展示**：所有展示 title 的前端（设置页、填写页、编辑页顶部/面包屑、列表页）将 `\n` 渲染为换行（如 CSS `white-space: pre-line` 或拆分为多行节点）。主副标题：约定「第一行为主标题，\n 后为副标题」，同一 title 存储；展示时可对首行与后续行区分样式（如主标题加粗、副标题小号灰色）。**编辑**：仅在**设置页**编辑标题与说明；使用 textarea 或保留 \n 的输入方式，保证输入 \n 能写入后端。 |

### 1.2 编辑页不重复编辑标题与说明

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 产品约定 | 问卷标题、问卷说明**仅在设置页编辑**，编辑页不重复提供编辑 | 当前即如此：编辑页仅面包屑展示标题并链至设置页 | **无需修改**。编辑页保持现状：不增加标题/说明的编辑区；标题与说明的编辑、保存草稿（含标题说明）均在设置页完成。 |

### 1.3 导出 Excel：身份证等长数字按文本存储

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 范围说明 §6、设计详稿 2.7、问卷星对标 | 导出 Excel 时**身份证等长数字**按文本存储（如前加单引号或设置单元格格式），避免科学计数法 | 导出统一 `setCellValue(String)`，未设单元格格式，长数字可能被 Excel 当数字 | 在 `SurveyServiceImpl.exportResponses` 中：对**填空题**（SHORT_TEXT/LONG_TEXT）的答案列，若内容为纯数字且长度≥某阈值（如 ≥10），或题目 config 中标注为身份证/编号类（可选），则对该单元格设置为**文本格式**（Apache POI：`CellStyle` 的 `dataFormat` 为 `"@"` 或 `@`，或 setCellValue 前设 `cell.setCellType(CellType.STRING)` 并写入带前导单引号 `'` 的字符串）。建议：所有填空答案列统一用文本格式写入，或至少对「纯数字且长度≥10」的 value 用文本格式，以覆盖身份证、学号等。 |

### 1.4 填空题：校验类型（数字/邮箱/手机/身份证/URL/正则）

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 范围说明 §2、设计详稿 1.3、问卷星对标 | 填空题支持**校验类型**（number/integer/email/phone/idcard/url/regex）、maxLength、regexPattern | 当前仅 placeholder、multiline，无格式校验 | **编辑页**：填空题目 config 增加 validationType（下拉）、maxLength、regexPattern（当 validationType=regex 时）的编辑。**填写页**：根据 config 在提交前或失焦时做格式校验（前端 + 后端 FillServiceImpl.validateSubmitItems 中对 SHORT_TEXT/LONG_TEXT 按 validationType 校验）。正则可存 regexPattern，后端用 Pattern 校验。 |

### 1.5 单选/多选：选项随机、竖向/横向、标签化

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 范围说明 §2、设计详稿 1.3、问卷星对标 | 单选/多选支持 **optionsRandom**、**layout**（vertical/horizontal）、**optionsAsTags** | config 已预留字段，编辑页与填写页未使用 | **编辑页**：单选题/多选题编辑区增加「选项随机」「排列方式（竖向/横向）」「标签化呈现」的勾选或下拉，写入 config。**填写页**：读取 config，optionsRandom=true 时打乱选项顺序展示；layout=horizontal 时横向排列；optionsAsTags=true 时用标签样式渲染选项。 |

### 1.6 防重复扩展（密码列表、短信验证码、IP、同一电脑/手机）

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 范围说明 §3、设计详稿 1.4、问卷星 hepid_280 | 除「每人限填一次（user_id）」+ 匿名外，支持**密码列表**、**短信验证码**、**IP 限制**、**同一电脑/手机限制** | 仅 limit_once_per_user、allow_anonymous | **数据**：Survey 表或独立设置表增加字段/表（如 limit_by_password、limit_by_sms、limit_by_ip、limit_by_device 及对应配置）。**设置页**：增加防重复方式选择与配置（密码列表上传/录入、短信验证开关、IP 限填次数、同一设备限填次数）。**填写端**：GET 填写元数据时返回防重复策略；进入页或提交前按策略校验（密码输入、短信验证码、IP 计数、Cookie/设备标识计数），不通过则 4xx 明确提示。 |

---

## 二、第一步范围内与问卷星有差异（需对齐）

### 2.1 问卷标题展示方式（与问卷星一致）

| 问卷星 | 当前实现 | 修改要点 |
|--------|----------|----------|
| 标题支持换行、主副标题区分展示 | 单行展示，无 \n 解析 | 与 **1.1** 一致：所有展示 title 的页面支持 \n 换行及主/副标题呈现（对标问卷星编辑与填写页标题效果）。 |

### 2.2 导出 Excel 长数字列（与问卷星一致）

| 问卷星 | 当前实现 | 修改要点 |
|--------|----------|----------|
| 下载原始答卷时，身份证等长数字按文本，避免科学计数法 | 未做 | 与 **1.3** 一致：填空列或长数字列按文本格式导出。 |

---

## 三、第一步范围内需确认或微调的项

### 3.1 统计与导出：已删除题目

| 范围出处 | 要求 | 当前情况 | 建议 |
|----------|------|----------|------|
| 范围说明 §4 | 历史答卷中**已删除的题目**在统计/导出中**留空或标注「题目已删除」** | 统计与导出均按**当前题目列表**生成；已删题不在表头，旧答卷对应数据不显示（相当于留空） | **已满足**「留空」语义：表头仅为当前题目，旧答卷无该项则单元格为空。若产品要求对「该答卷包含已删题目的作答」做显式标注（如导出多一列「题目已删除」或详情页提示），再单独加；否则无需改代码。 |

### 3.2 填写页问卷标题/说明

| 范围出处 | 要求 | 当前情况 | 修改要点 |
|----------|------|----------|----------|
| 设计详稿 3.7 | 填写页顶部：问卷标题、问卷说明 | 使用 `meta.title` / `meta.description`，未将 \n 转为换行 | 与 **1.1** 一致：填写页展示 title/description 时支持 \n 换行（及主副标题样式）。若使用 survey-react-ui 的 title，需传入支持换行的内容或自定义标题组件。 |

---

## 四、实施顺序建议

1. **问卷标题 \n 与主副标题（1.1 + 2.1 + 3.2）**  
   约定存储不变（`title` 含 `\n`），在前端所有展示处（设置页、填写页、编辑页面包屑、列表页）支持换行与主副标题样式；标题与说明仅在**设置页**编辑并支持输入 \n。

2. **导出 Excel 长数字按文本（1.3 + 2.2）**  
   在 `exportResponses` 中对填空答案列（或长数字内容）设单元格文本格式。

3. **填空校验类型（1.4）**  
   编辑页填空 config 增加 validationType/maxLength/regexPattern；填写页与提交接口按 config 校验。

4. **单选/多选选项随机、横向、标签化（1.5）**  
   编辑页写入 optionsRandom、layout、optionsAsTags；填写页按 config 展示。

5. **防重复扩展（1.6）**  
   数据模型与设置页、填写端校验联动（密码/短信/IP/同一设备）。

---

## 五、第一步须完整实现的题型与设置（单选 / 多选 / 填空 / 量表 + 防重复扩展）

以下均在**第一步范围**内，须在本阶段**完整实现**，不遗留到下一步。

### 5.1 四种题型及题型内能力

| 题型 | 第一步须实现的能力（范围说明 §2） |
|------|----------------------------------|
| **单选题** | 选一项；选项增删改、排序；「其他」选项且可带填空；**选项随机**、**竖向/横向排列**、**标签化呈现**（对标问卷星） |
| **多选题** | 选多项；最少/最多选 N 项；选项增删改、排序；「其他」+ 填空；**选项随机**、**竖向/横向**、**标签化** |
| **填空题** | **单行/多行**；**占位提示（placeholder）**；是否必填；**校验类型**（数字/整数/邮箱/手机/身份证/URL/正则等，对标问卷星填空属性） |
| **量表题** | **线性量表**，**1–N 可配置**（如 5/7/10）；**左右端点文案**可填；每题可设不同刻度 |

题目通用：题干、题目说明、必填、自动编号、题目操作（新增/复制/删除/拖拽排序）均按范围说明 §2.2 完整实现。

### 5.2 防重复（问卷级，第一步完整做）

- **每人限填一次**（按登录 user_id）+ **匿名**（已实现）。
- **防重复扩展**（对标问卷星 hepid_280）：**密码列表**、**短信验证码**、**IP 限制**、**同一电脑/手机限制**等，与按 user_id 限填、匿名组合使用；在第一步内实现。

---

## 六、第一步明确不做的（无需在本清单实现）

以下为第一步仍不做的能力或题型：

- **NPS 等量表预设**（非线性量表）：第一步只做线性量表 1–N + 端点文案；NPS/满意度等留后续。
- **逻辑跳题、矩阵题、交叉分析等**：范围说明 §2 明确排除（下拉、矩阵、排序、比重、逻辑设置等），属第二步及以后。

---

**文档状态**：作为第一步收尾的代码修改指导；完成上述清单后，第一步范围内功能与问卷星在标题、导出方面的差异应已补齐，且不将第一步所列项留到下一步。
